<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
      :root {
        --light: #EAEAEA;
        --purple: #573FD7;
        --blue: #11358B;
        --orange: #E48F24;
        --transition-speed: 0.3s;
        --sidebar-width: 250px;
        --sidebar-collapsed-width: 70px;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideIn {
        from { transform: translateX(-20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      
      * {
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        padding: 0;
        color: #333;
        background: linear-gradient(to bottom right, #573FD5, #1f46a3);
        min-height: 100vh;
        display: flex;
        overflow-x: hidden;
      }
      
      .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
        transition: margin-left var(--transition-speed);
      }
      
      h1 {
        color: var(--light);
        margin-bottom: 30px;
        font-weight: 600;
        font-size: 32px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      
      .nav-tabs {
        display: flex;
        margin-bottom: 30px;
        background-color: rgba(255,255,255,0.1);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        padding: 5px;
      }
      
      .nav-tab {
        padding: 15px 25px;
        cursor: pointer;
        color: var(--light);
        transition: all var(--transition-speed) ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        z-index: 2;
        flex: 1;
        text-align: center;
        border-radius: 8px;
        font-weight: 500;
      }
      
      .nav-tab.active {
        color: #333;
        font-weight: 600;
      }
      
      .tab-indicator {
        position: absolute;
        height: calc(100% - 10px);
        background-color: white;
        border-radius: 8px;
        transition: all var(--transition-speed) cubic-bezier(0.68, -0.55, 0.27, 1.55);
        z-index: 1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .table-responsive {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      }
      
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        font-size: 14px;
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        animation: fadeIn 0.5s ease-out;
      }
      
      th {
        background-color: var(--blue);
        color: white;
        padding: 14px 15px;
        text-align: left;
        font-weight: 600;
        position: sticky;
        top: 0;
      }
      
      td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--light);
        vertical-align: top;
      }
      
      tr:last-child td {
        border-bottom: none;
      }
      
      tr:nth-child(even) {
        background-color: rgba(234, 234, 234, 0.3);
      }
      
      tr:hover {
        background-color: rgba(234, 234, 234, 0.5);
      }
      
      .loading {
        text-align: center;
        padding: 40px;
        font-style: italic;
        color: var(--light);
        background-color: rgba(255,255,255,0.1);
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      }
      
      .error {
        color: #fff;
        padding: 20px;
        text-align: center;
        background-color: rgba(211, 47, 47, 0.8);
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        animation: fadeIn 0.3s ease-out;
      }
      
      .success {
        color: #fff;
        padding: 20px;
        text-align: center;
        background-color: rgba(56, 142, 60, 0.8);
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        animation: fadeIn 0.3s ease-out;
      }
      
      a {
        color: var(--purple);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s;
      }
      
      a:hover {
        text-decoration: underline;
        color: var(--blue);
      }
      
      .status-complete, .status-completed {
        color: #388e3c;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .status-pending, .status-in-progress {
        color: var(--orange);
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .status-cancelled, .status-canceled {
        color: #d32f2f;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .status-rescheduled {
        color: var(--blue);
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .date-time {
        white-space: nowrap;
      }
      
      .button {
        background-color: var(--purple);
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
      
      .button:hover {
        background-color: #4930b8;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      
      .save-button {
        background-color: #0f9d58;
        font-weight: 600;
        padding: 12px 24px;
      }
      
      .save-button:hover {
        background-color: #0b8043;
      }
      
      .cancel-button {
        background-color: #db4437;
        font-weight: 600;
        padding: 12px 24px;
      }
      
      .cancel-button:hover {
        background-color: #c53929;
      }
      
      .view-button {
        background-color: var(--blue);
        padding: 8px 14px;
        font-size: 13px;
      }
      
      .view-button:hover {
        background-color: #0a2a70;
      }
      
      .page {
        display: none;
        animation: fadeIn 0.5s ease-out;
      }
      
      .page.active {
        display: block;
      }
      
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      
      .card {
        background-color: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        transition: transform 0.3s, box-shadow 0.3s;
        animation: fadeIn 0.5s ease-out;
        animation-fill-mode: both;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      }
      
      .card-header {
        padding: 18px;
        background-color: var(--blue);
        border-bottom: 1px solid var(--light);
        color: white;
      }
      
      .card-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        word-break: break-word;
      }
      
      .card-body {
        padding: 18px;
        flex: 1;
      }
      
      .card-footer {
        padding: 15px 18px;
        background-color: rgba(234, 234, 234, 0.3);
        border-top: 1px solid var(--light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .trainee-count {
        font-size: 14px;
        color: #666;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .trainee-list {
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
      }
      
      .trainee-item {
        padding: 12px;
        border-bottom: 1px solid var(--light);
        transition: background-color 0.2s;
        animation: slideIn 0.3s ease-out;
        animation-fill-mode: both;
      }
      
      .trainee-item:hover {
        background-color: rgba(234, 234, 234, 0.3);
      }
      
      .trainee-item:last-child {
        border-bottom: none;
      }
      
      .trainee-name {
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .trainee-details {
        margin-top: 5px;
        font-size: 13px;
        color: #666;
      }
      
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(3px);
        animation: fadeIn 0.3s ease-out;
        padding: 15px;
      }
      
      .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        position: relative;
        animation: fadeIn 0.3s ease-out;
        transform: scale(0.95);
        animation-fill-mode: forwards;
      }
      
      .form-group {
        margin-bottom: 22px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #444;
        font-size: 15px;
      }
      
      .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        box-sizing: border-box;
        background-color: #f9f9f9;
      }
      
      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }
      
      .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        border-color: var(--purple);
        outline: none;
        box-shadow: 0 0 0 3px rgba(87, 63, 215, 0.2);
        background-color: #fff;
      }
      
      .button-group {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
      }
      
      .grade-ungraded {
        color: #888;
        font-style: italic;
      }
      
      .grade-pass {
        color: #388e3c;
        font-weight: bold;
      }
      
      .grade-fail {
        color: #d32f2f;
        font-weight: bold;
      }
      
      .modal-title {
        margin-top: 0;
        margin-bottom: 25px;
        color: var(--blue);
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(17, 53, 139, 0.1);
        word-break: break-word;
      }
      
      .modal-subtitle {
        color: #666;
        margin-bottom: 20px;
      }
      
      .close-button {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 22px;
        cursor: pointer;
        color: #666;
        transition: all 0.2s;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: rgba(0,0,0,0.05);
      }
      
      .close-button:hover {
        color: #333;
        background-color: rgba(0,0,0,0.1);
        transform: rotate(90deg);
      }
      
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 5px;
      }
      
      .badge-primary {
        background-color: rgba(87, 63, 215, 0.1);
        color: var(--purple);
      }
      
      /* Chip styling */
      .chip-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      
      .chip {
        display: inline-flex;
        align-items: center;
        background-color: rgba(87, 63, 215, 0.1);
        color: var(--purple);
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
      }
      
      .chip i {
        margin-right: 5px;
        font-size: 10px;
      }
      
      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 300px;
      }
      
      .toast {
        padding: 15px;
        border-radius: 8px;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
        cursor: pointer;
      }
      
      @keyframes fadeOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(20px); }
      }
      
      .toast-success {
        background-color: #0f9d58;
      }
      
      .toast-error {
        background-color: #db4437;
      }
      
      .toast-info {
        background-color: var(--blue);
      }
      
      /* Spinner */
      .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        backdrop-filter: blur(2px);
      }
      
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Select2 custom styling */
      .select2-container--default .select2-selection--multiple,
      .select2-container--default .select2-selection--single {
        border-color: #ddd;
        border-radius: 8px;
        padding: 5px;
        min-height: 45px;
        background-color: #f9f9f9;
      }
      
      .select2-container--default.select2-container--focus .select2-selection--multiple,
      .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: var(--purple);
        box-shadow: 0 0 0 3px rgba(87, 63, 215, 0.2);
        background-color: #fff;
      }
      
      .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: rgba(87, 63, 215, 0.1);
        color: var(--purple);
        border: none;
        border-radius: 16px;
        padding: 5px 10px;
        margin: 3px;
        font-size: 13px;
        display: flex;
        align-items: center;
      }
      
      .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: var(--purple);
        margin-right: 5px;
        border-right: none;
      }
      
      .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
        background-color: rgba(87, 63, 215, 0.2);
        color: var(--purple);
      }
      
      .select2-dropdown {
        border-color: #ddd;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      
      .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: var(--purple);
      }
      
      .select2-container--default .select2-search--dropdown .select2-search__field {
        border-color: #ddd;
        border-radius: 4px;
        padding: 8px;
      }
      
      .select2-container--default .select2-search--dropdown .select2-search__field:focus {
        border-color: var(--purple);
        outline: none;
      }
      
      /* Flatpickr custom styling */
      .flatpickr-calendar {
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        font-family: 'Segoe UI', Arial, sans-serif;
      }
      
      .flatpickr-day.selected {
        background: var(--purple);
        border-color: var(--purple);
      }
      
      .flatpickr-day:hover {
        background: rgba(87, 63, 215, 0.1);
      }
      
      .flatpickr-day.today {
        border-color: var(--purple);
      }
      
      .flatpickr-months .flatpickr-month {
        background-color: var(--blue);
      }
      
      .flatpickr-current-month .flatpickr-monthDropdown-months,
      .flatpickr-current-month input.cur-year {
        color: white;
      }
      
      .flatpickr-weekday {
        color: var(--blue);
        font-weight: bold;
      }
      
      .flatpickr-time input:hover,
      .flatpickr-time .flatpickr-am-pm:hover,
      .flatpickr-time input:focus,
      .flatpickr-time .flatpickr-am-pm:focus {
        background: rgba(87, 63, 215, 0.1);
      }
      
      .flatpickr-input {
        padding-left: 40px !important;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23573FD7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>');
        background-repeat: no-repeat;
        background-position: 15px center;
      }
      
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      
      ::-webkit-scrollbar-thumb {
        background: #bbb;
        border-radius: 4px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: #999;
      }
      
      /* Sidebar Styles */
      .sidebar {
        background-color: #1a1f2c;
        height: 100vh;
        width: var(--sidebar-width);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 100;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        transition: width var(--transition-speed) ease;
        display: flex;
        flex-direction: column;
      }

      .sidebar.collapsed {
        width: var(--sidebar-collapsed-width);
      }

      .sidebar.hidden {
        transform: translateX(-100%);
      }

      .sidebar-header {
        padding: 20px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        background-color: #141824;
        color: white;
      }

      .sidebar-logo {
        width: 40px;
        height: 40px;
        background-color: #E48F24;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
      }

      .sidebar-logo i {
        font-size: 20px;
      }

      .sidebar-title {
        font-weight: 600;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        transition: opacity 0.3s ease;
      }

      .sidebar.collapsed .sidebar-title {
        opacity: 0;
        width: 0;
      }

      .sidebar-menu {
        padding: 20px 0;
        flex-grow: 1;
        overflow-y: auto;
      }

      .sidebar-item {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        transition: all 0.3s ease;
        margin: 4px 8px;
        border-radius: 8px;
      }

      .sidebar-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .sidebar-item i {
        font-size: 18px;
        min-width: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar-item span {
        margin-left: 10px;
        white-space: nowrap;
        overflow: hidden;
        transition: opacity 0.3s ease;
      }

      .sidebar.collapsed .sidebar-item span {
        opacity: 0;
        width: 0;
      }

      .sidebar-toggle {
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        color: rgba(255, 255, 255, 0.7);
      }

      .sidebar-toggle:hover {
        color: #fff;
      }

      .sidebar-toggle i {
        transition: transform 0.3s ease;
      }

      .sidebar.collapsed .sidebar-toggle {
        justify-content: center;
      }

      .sidebar.collapsed .sidebar-toggle i {
        transform: rotate(180deg);
      }

      .sidebar-mobile-toggle {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #573FD7;
        color: white;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 99;
      }

      /* Main content wrapper */
      .main-content {
        flex: 1;
        margin-left: var(--sidebar-width);
        transition: margin-left var(--transition-speed) ease;
        width: calc(100% - var(--sidebar-width));
      }

      .main-content.sidebar-collapsed {
        margin-left: var(--sidebar-collapsed-width);
        width: calc(100% - var(--sidebar-collapsed-width));
      }
      
      /* Filter styles */
      .filter-container {
        margin-bottom: 20px;
        background-color: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }
      
      .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 15px;
      }
      
      .filter-item {
        flex: 1;
        min-width: 200px;
      }
      
      .filter-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: white;
        font-size: 14px;
      }
      
      .filter-select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 14px;
      }
      
      .filter-select option {
        background-color: #1f46a3;
        color: white;
      }
      
      .filter-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .filter-button {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }
      
      .filter-apply {
        background-color: var(--purple);
        color: white;
      }
      
      .filter-apply:hover {
        background-color: #4930b8;
      }
      
      .filter-reset {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
      }
      
      .filter-reset:hover {
        background-color: rgba(255, 255, 255, 0.3);
      }
      
      /* Remarks styles */
      .remarks-container {
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 12px;
        margin-top: 10px;
        border-left: 3px solid var(--purple);
      }
      
      .remarks-title {
        font-weight: 600;
        color: var(--purple);
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 5px;
        font-size: 13px;
      }
      
      .remarks-content {
        color: #666;
        font-size: 13px;
        line-height: 1.5;
        white-space: pre-wrap;
      }
      
      .remarks-empty {
        color: #999;
        font-style: italic;
        font-size: 13px;
      }
      
      /* Search bar styles */
      .search-container {
        margin-bottom: 20px;
        background-color: rgba(255, 255, 255, 0.15);
        padding: 0;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
      }

      .search-container:hover, .search-container:focus-within {
        background-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
      }

      .search-input {
        flex: 1;
        padding: 16px 20px 16px 55px;
        border: none;
        border-radius: 50px;
        background-color: transparent;
        color: white;
        font-size: 16px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
        background-repeat: no-repeat;
        background-position: 20px center;
        transition: all 0.3s ease;
      }

      .search-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
        font-weight: 400;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
      }

      .search-input:focus::placeholder {
        opacity: 0.5;
      }

      .clear-search {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
        margin: 0;
        opacity: 0.7;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.1);
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
      }

      .clear-search:hover {
        opacity: 1;
        background-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-50%) rotate(90deg);
      }

      .search-results {
        margin-top: -15px;
        margin-bottom: 15px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        padding-left: 20px;
        display: flex;
        align-items: center;
        animation: fadeIn 0.3s ease-out;
      }

      .search-results:before {
        content: "";
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: var(--purple);
        border-radius: 50%;
        margin-right: 8px;
      }

      @media (max-width: 768px) {
        .search-container {
          border-radius: 30px;
        }
        
        .search-input {
          padding: 14px 50px 14px 45px;
          font-size: 15px;
          background-position: 15px center;
        }
        
        .clear-search {
          width: 32px;
          height: 32px;
          right: 10px;
        }
      }
      
      /* Mobile responsiveness improvements */
      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
        }
        
        .sidebar.active {
          transform: translateX(0);
        }
        
        .sidebar-mobile-toggle {
          display: flex;
        }

        .main-content {
          margin-left: 0;
          width: 100%;
        }
        
        .filter-row {
          flex-direction: column;
          gap: 10px;
        }
        
        .filter-item {
          width: 100%;
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }
        
        h1 {
          font-size: 24px;
          line-height: 1.3;
        }
        
        .nav-tab {
          padding: 10px;
          font-size: 14px;
        }
        
        .nav-tab i {
          margin-right: 5px;
        }
        
        .modal-content {
          padding: 20px;
          width: 95%;
        }
        
        .button {
          padding: 8px 12px;
          font-size: 13px;
        }
        
        .card-grid {
          grid-template-columns: 1fr;
        }
        
        th, td {
          padding: 10px;
          font-size: 13px;
        }
        
        .button-group {
          flex-direction: column;
          width: 100%;
        }
        
        .button-group .button {
          width: 100%;
          margin-right: 0;
          margin-bottom: 10px;
        }
        
        .card-footer {
          flex-direction: column;
          align-items: flex-start;
        }
        
        .card-footer .button {
          width: 100%;
          margin-top: 10px;
        }
        
        .trainee-name {
          flex-direction: column;
          align-items: flex-start;
        }
        
        .trainee-name .badge {
          margin-left: 0;
          margin-top: 5px;
        }
        
        .toast-container {
          left: 20px;
          right: 20px;
          max-width: none;
        }
        
        .modal-title {
          font-size: 20px;
        }
        
        .close-button {
          top: 10px;
          right: 10px;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 10px;
        }
        
        h1 {
          font-size: 20px;
        }
        
        .nav-tab {
          padding: 8px;
          font-size: 12px;
        }
        
        .nav-tab i {
          font-size: 14px;
        }
        
        .table-responsive {
          margin-left: -10px;
          margin-right: -10px;
          width: calc(100% + 20px);
          border-radius: 0;
        }
      }

      .register-button {
        background-color: #E48F24;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 50px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: flex;
        align-items: center;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(228, 143, 36, 0.3);
        text-align: center
      }

      .register-button i {
        margin-right: 18px;
      }

      .register-button:hover {
        background-color: #d17f1c;
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(228, 143, 36, 0.4);
      }
      
      /* Custom tag input for device serial numbers */
      .tag-input-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
        min-height: 45px;
      }
      
      .tag-input-container:focus-within {
        border-color: var(--purple);
        box-shadow: 0 0 0 3px rgba(87, 63, 215, 0.2);
        background-color: #fff;
      }
      
      .tag {
        display: inline-flex;
        align-items: center;
        background-color: rgba(87, 63, 215, 0.1);
        color: var(--purple);
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 500;
      }
      
      .tag-remove {
        margin-left: 6px;
        cursor: pointer;
        font-size: 12px;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: rgba(87, 63, 215, 0.1);
        transition: all 0.2s;
      }
      
      .tag-remove:hover {
        background-color: rgba(87, 63, 215, 0.3);
      }
      
      .tag-input {
        flex: 1;
        min-width: 100px;
        border: none;
        outline: none;
        padding: 4px;
        font-size: 14px;
        background: transparent;
      }
      
      .tag-suggestions {
        position: absolute;
        width: calc(100% - 60px);
        max-height: 200px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        z-index: 10;
        margin-top: 5px;
      }
      
      .tag-suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      
      .tag-suggestion-item:hover {
        background-color: rgba(87, 63, 215, 0.1);
      }
    </style>
  </head>
  <body>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <i class="fas fa-book-open-reader text-white"></i>
        </div>
        <div class="sidebar-title">Laser Training System <br> (LTS)</div>
      </div>
      <div class="sidebar-menu">
        <a href="YOUR_DASHBOARD_DEPLOYMENT_LINK" class="sidebar-item">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
        </a>
        <a href="YOUR_TRAINEE_DATABASE_DEPLOYMENT_LINK" class="sidebar-item">
          <i class="fas fa-users"></i>
          <span>Trainee Database</span>
        </a>
        <a class="sidebar-item">
          <i class="fas fa-chalkboard-teacher"></i>
          <span>Training Management</span>
        </a>
        <a href="YOUR_QUESTIONS_MANAGEMENT_DEPLOYMENT_LINK" class="sidebar-item">
          <i class="fas fa-question-circle"></i>
          <span>Questions Management</span>
        </a>
        <a href="YOUR_SETTINGS_DEPLOYMENT_LINK" class="sidebar-item">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
      </div>
      <div id="sidebar-toggle" class="sidebar-toggle">
        <i class="fas fa-chevron-left"></i>
      </div>
    </div>

    <!-- Mobile sidebar toggle button -->
    <div id="sidebar-mobile-toggle" class="sidebar-mobile-toggle">
      <i class="fas fa-bars"></i>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="main-content">
      <div class="container">
        <h1><i class="fas fa-chalkboard-teacher"></i> <strong>Training Management</strong></h1>
            <a href="YOUR_TRAINING_CREATION_LINK" target="_blank" class="register-button">
              <i class="fas fa-user-plus"></i> Create a Training
            </a>
        <div class="nav-tabs">
          <div id="tab-trainings" class="nav-tab active" onclick="switchTab('trainings')">
            <i class="fas fa-list"></i> All Trainings
          </div>
          <div id="tab-trainees" class="nav-tab" onclick="switchTab('trainees')">
            <i class="fas fa-users"></i> Participating Trainees
          </div>
          <div class="tab-indicator"></div>
        </div>
        
        <div id="loading" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Loading data...
        </div>
        <div id="error" class="error" style="display:none;"></div>
        <div id="success" class="success" style="display:none;"></div>
        
        <!-- All Trainings Page -->
        <div id="page-trainings" class="page active">
          <!-- Search Bar -->
          <div id="trainingsSearchContainer" class="search-container" style="display:none;">
            <input type="text" id="trainingsSearchInput" class="search-input" placeholder="Search trainings..." onkeyup="searchTrainings()">
            <button id="clearTrainingsSearch" class="clear-search" onclick="clearTrainingsSearch()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="trainingsSearchResults" class="search-results" style="display:none;"></div>
          
          <!-- Filter Container -->
          <div id="trainingsFilterContainer" class="filter-container" style="display:none;">
            <div class="filter-row">
              <div class="filter-item">
                <label class="filter-label"><i class="fas fa-tag"></i> Training ID</label>
                <select id="filter-training-name" class="filter-select">
                  <option value="">All Training IDs</option>
                </select>
              </div>
              <div class="filter-item">
                <label class="filter-label"><i class="fas fa-user-tie"></i> Trainer</label>
                <select id="filter-trainer" class="filter-select">
                  <option value="">All Trainers</option>
                </select>
              </div>
              <div class="filter-item">
                <label class="filter-label"><i class="fas fa-hospital"></i> Healthcare Centre</label>
                <select id="filter-healthcare" class="filter-select">
                  <option value="">All Healthcare Centres</option>
                </select>
              </div>
            </div>
            <div class="filter-row">
              <div class="filter-item">
                <label class="filter-label"><i class="fas fa-barcode"></i> Device Serial Number</label>
                <select id="filter-device" class="filter-select">
                  <option value="">All Devices</option>
                </select>
              </div>
              <div class="filter-item">
                <label class="filter-label"><i class="fas fa-tag"></i> Training Type</label>
                <select id="filter-training-type" class="filter-select">
                  <option value="">All Training Types</option>
                </select>
              </div>
              <div class="filter-item">
                <label class="filter-label"><i class="fas fa-info-circle"></i> Status</label>
                <select id="filter-status" class="filter-select">
                  <option value="">All Statuses</option>
                </select>
              </div>
            </div>
            <div class="filter-buttons">
              <button id="reset-filters" class="filter-button filter-reset"><i class="fas fa-undo"></i> Reset Filters</button>
              <button id="apply-filters" class="filter-button filter-apply"><i class="fas fa-filter"></i> Apply Filters</button>
            </div>
          </div>
          
          <div id="trainingsTableContainer" style="display:none;">
            <div class="table-responsive">
              <table id="trainingsTable">
                <thead>
                  <tr>
                    <th>Timestamp</th>
                    <th>Training ID</th>
                    <th>Trainer</th>
                    <th>Healthcare Centre</th>
                    <th>Start Date & Time</th>
                    <th>End Date & Time</th>
                    <th>Device Serial Number</th>
                    <th>Training Type</th>
                    <th>Gradebook</th>
                    <th>Status</th>
                    <th>WhatsApp Group</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="trainingsData">
                  <!-- Data will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
<!-- Participating Trainees Page -->
<div id="page-trainees" class="page">
  <!-- Search Bar for Trainees -->
  <div id="traineesSearchContainer" class="search-container" style="display:none;">
    <input type="text" id="traineesSearchInput" class="search-input" placeholder="Search trainees..." onkeyup="searchTrainees()">
    <button id="clearTraineesSearch" class="clear-search" onclick="clearTraineesSearch()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="traineesSearchResults" class="search-results" style="display:none;"></div>
  
  <div id="traineesCardContainer" style="display:none;">
    <div id="traineesCards" class="card-grid">
      <!-- Cards will be inserted here -->
    </div>
  </div>
</div>
        
        <!-- Toast Container -->
        <div id="toastContainer" class="toast-container"></div>
      </div>
    </div>
    
    <script>
      // Store data
      let trainingsData = [];
      let traineesData = [];
      let dropdownOptions = null;
      let currentUserEmail = null;
      let currentPage = 'trainings';
      let filteredTrainingsData = []; // For storing filtered data
      let filteredTraineesData = []; // For storing filtered trainee data
      
      // Load data when the page loads
      window.onload = function() {
        loadTrainings();
        loadDropdownOptions();
        getCurrentUserEmail();
        updateTabIndicator();
        setupSidebar();
        setupFilterListeners();
      };
      
      function updateTabIndicator() {
        const activeTab = document.querySelector('.nav-tab.active');
        const tabIndicator = document.querySelector('.tab-indicator');
        
        if (activeTab && tabIndicator) {
          const tabWidth = activeTab.offsetWidth;
          const tabLeft = activeTab.offsetLeft;
          
          tabIndicator.style.width = tabWidth + 'px';
          tabIndicator.style.left = tabLeft + 'px';
        }
      }
      
      function switchTab(page) {
        // Update tab styling
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.getElementById(`tab-${page}`).classList.add('active');
        
        // Update tab indicator
        updateTabIndicator();
        
        // Update page visibility
        document.querySelectorAll('.page').forEach(pageEl => {
          pageEl.classList.remove('active');
        });
        
        // Small delay for animation effect
        setTimeout(() => {
          document.getElementById(`page-${page}`).classList.add('active');
        }, 50);
        
        // Set current page
        currentPage = page;
        
        // Load data if needed
        if (page === 'trainings' && trainingsData.length === 0) {
          loadTrainings();
        } else if (page === 'trainees' && traineesData.length === 0) {
          loadTrainees();
        }
      }
      
      function loadTrainings() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('trainingsTableContainer').style.display = 'none';
        document.getElementById('trainingsFilterContainer').style.display = 'none';
        document.getElementById('trainingsSearchContainer').style.display = 'none';
        document.getElementById('trainingsSearchResults').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';
        
        google.script.run
          .withSuccessHandler(handleTrainingsResponse)
          .withFailureHandler(showError)
          .getAllTrainings();
      }
      
      function loadTrainees() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('traineesCardContainer').style.display = 'none';
        document.getElementById('traineesSearchContainer').style.display = 'none';
        document.getElementById('traineesSearchResults').style.display = 'none';
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';
        
        google.script.run
          .withSuccessHandler(handleTraineesResponse)
          .withFailureHandler(showError)
          .getParticipatingTrainees();
      }
      
      function loadDropdownOptions() {
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success) {
              dropdownOptions = response.options;
            } else {
              console.error("Failed to load dropdown options:", response ? response.error : "Unknown error");
            }
          })
          .withFailureHandler(function(error) {
            console.error("Error loading dropdown options:", error);
          })
          .getDropdownOptions();
      }
      
      function getCurrentUserEmail() {
        google.script.run
          .withSuccessHandler(function(email) {
            currentUserEmail = email;
          })
          .withFailureHandler(function(error) {
            console.error("Error getting user email:", error);
          })
          .getCurrentUserEmail();
      }
      
      function handleTrainingsResponse(response) {
        try {
          if (response && response.success === true) {
            if (response.data && response.data.length > 0) {
              trainingsData = response.data;
              filteredTrainingsData = [...trainingsData]; // Initialize filtered data
              displayTrainings(trainingsData);
              populateFilterOptions(trainingsData);
              document.getElementById('trainingsFilterContainer').style.display = 'block';
              document.getElementById('trainingsSearchContainer').style.display = 'block';
            } else {
              // Handle empty data case
              trainingsData = [];
              filteredTrainingsData = [];
              displayTrainings([]);
              document.getElementById('trainingsFilterContainer').style.display = 'none';
              document.getElementById('trainingsSearchContainer').style.display = 'none';
              if (response.message) {
                showToast(response.message, 'info');
              }
            }
          } else if (response && response.success === false) {
            showError(response.error || 'Unknown server error');
          } else {
            showError('Invalid response format from server.');
          }
        } catch (error) {
          console.error("Error in handleTrainingsResponse:", error);
          showError("An error occurred while processing the training data: " + error.message);
        }
      }
      
      function handleTraineesResponse(response) {
        try {
          if (response && response.success === true) {
            if (response.data && response.data.length > 0) {
              traineesData = response.data;
              filteredTraineesData = [...traineesData]; // Initialize filtered trainee data
              displayTraineeCards(traineesData);
              document.getElementById('traineesSearchContainer').style.display = 'block';
            } else {
              // Handle empty data case
              traineesData = [];
              filteredTraineesData = [];
              displayTraineeCards([]);
              document.getElementById('traineesSearchContainer').style.display = 'none';
              if (response.message) {
                showToast(response.message, 'info');
              }
            }
          } else if (response && response.success === false) {
            showError(response.error || 'Unknown server error');
          } else {
            showError('Invalid response format from server.');
          }
        } catch (error) {
          console.error("Error in handleTraineesResponse:", error);
          showError("An error occurred while processing the trainee data: " + error.message);
        }
      }
      
      function populateFilterOptions(trainings) {
        try {
          // Get unique values for each filterable column
          const trainingNames = new Set();
          const trainers = new Set();
          const healthcareCentres = new Set();
          const deviceSerials = new Set();
          const trainingTypes = new Set();
          const statuses = new Set();

          trainings.forEach(training => {
            if (training.trainingName) trainingNames.add(training.trainingName);
            if (training.trainer) trainers.add(training.trainer);

            // For healthcare centres (which can be comma-separate  trainers.add(training.trainer);

            // For healthcare centres (which can be comma-separated)
            if (typeof training.healthcareCentre === 'string') {
              const centres = training.healthcareCentre.split(',').map(s => s.trim()).filter(s => s);
              centres.forEach(centre => healthcareCentres.add(centre));
            }

            // For device serial numbers (which can be comma-separated or other format)
            if (training.deviceSerialNumber) {
              // Safely handle different data types for device serial numbers
              try {
                if (typeof training.deviceSerialNumber === 'string') {
                  const serials = training.deviceSerialNumber.split(',').map(s => s.trim()).filter(s => s);
                  serials.forEach(serial => deviceSerials.add(serial));
                } else if (Array.isArray(training.deviceSerialNumber)) {
                  training.deviceSerialNumber.forEach(serial => {
                    if (serial) deviceSerials.add(String(serial).trim());
                  });
                } else {
                  // Handle case where it's a number or other type
                  deviceSerials.add(String(training.deviceSerialNumber).trim());
                }
              } catch (error) {
                console.error("Error processing device serial number:", error);
                // Still add the raw value as a fallback
                deviceSerials.add(String(training.deviceSerialNumber));
              }
            }

            if (training.trainingType) trainingTypes.add(training.trainingType);
            if (training.trainingStatus) statuses.add(training.trainingStatus);
          });

          // Populate filter dropdowns
          populateFilterDropdown('filter-training-name', Array.from(trainingNames).sort());
          populateFilterDropdown('filter-trainer', Array.from(trainers).sort());
          populateFilterDropdown('filter-healthcare', Array.from(healthcareCentres).sort());
          populateFilterDropdown('filter-device', Array.from(deviceSerials).sort());
          populateFilterDropdown('filter-training-type', Array.from(trainingTypes).sort());
          populateFilterDropdown('filter-status', Array.from(statuses).sort());
        } catch (error) {
          console.error("Error in populateFilterOptions:", error);
          showToast("An error occurred while setting up filters: " + error.message, 'error');
        }
      }
      
      function populateFilterDropdown(id, options) {
        const dropdown = document.getElementById(id);
        const currentValue = dropdown.value; // Save current selection
        
        // Clear existing options except the first one (All...)
        while (dropdown.options.length > 1) {
          dropdown.remove(1);
        }
        
        // Add new options
        options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option;
          optionElement.textContent = option;
          dropdown.appendChild(optionElement);
        });
        
        // Restore selection if possible
        if (currentValue && options.includes(currentValue)) {
          dropdown.value = currentValue;
        }
      }
      
      function setupFilterListeners() {
        // Apply filters button
        document.getElementById('apply-filters').addEventListener('click', function() {
          applyFilters();
        });
        
        // Reset filters button
        document.getElementById('reset-filters').addEventListener('click', function() {
          resetFilters();
        });
      }
      
      function applyFilters() {
        const trainingNameFilter = document.getElementById('filter-training-name').value;
        const trainerFilter = document.getElementById('filter-trainer').value;
        const healthcareFilter = document.getElementById('filter-healthcare').value;
        const deviceFilter = document.getElementById('filter-device').value;
        const trainingTypeFilter = document.getElementById('filter-training-type').value;
        const statusFilter = document.getElementById('filter-status').value;
        
        // Filter the data
        filteredTrainingsData = trainingsData.filter(training => {
          try {
            // Training Name filter
            if (trainingNameFilter && training.trainingName !== trainingNameFilter) {
              return false;
            }
            
            // Trainer filter
            if (trainerFilter && training.trainer !== trainerFilter) {
              return false;
            }
            
            // Healthcare Centre filter (can be comma-separated)
            if (healthcareFilter && (!training.healthcareCentre || 
                !String(training.healthcareCentre).split(',').map(s => s.trim()).includes(healthcareFilter))) {
              return false;
            }
            
            // Device Serial Number filter (can be comma-separated)
            if (deviceFilter) {
              // Safely handle different data types for device serial numbers
              let hasMatchingDevice = false;
              
              if (typeof training.deviceSerialNumber === 'string') {
                hasMatchingDevice = training.deviceSerialNumber.split(',')
                  .map(s => s.trim())
                  .includes(deviceFilter);
              } else if (Array.isArray(training.deviceSerialNumber)) {
                hasMatchingDevice = training.deviceSerialNumber
                  .map(s => String(s).trim())
                  .includes(deviceFilter);
              } else if (training.deviceSerialNumber !== null && training.deviceSerialNumber !== undefined) {
                hasMatchingDevice = String(training.deviceSerialNumber).trim() === deviceFilter;
              }
              
              if (!hasMatchingDevice) return false;
            }
            
            // Training Type filter
            if (trainingTypeFilter && training.trainingType !== trainingTypeFilter) {
              return false;
            }
            
            // Status filter
            if (statusFilter && training.trainingStatus !== statusFilter) {
              return false;
            }
            
            return true;
          } catch (error) {
            console.error("Error filtering training:", error, training);
            // Include the item if there's an error to avoid hiding data
            return true;
          }
        });
        
        // Display filtered data
        displayTrainings(filteredTrainingsData);
      }
      
      function resetFilters() {
        // Reset all filter dropdowns
        document.getElementById('filter-training-name').value = '';
        document.getElementById('filter-trainer').value = '';
        document.getElementById('filter-healthcare').value = '';
        document.getElementById('filter-device').value = '';
        document.getElementById('filter-training-type').value = '';
        document.getElementById('filter-status').value = '';
        
        // Reset filtered data to all data
        filteredTrainingsData = [...trainingsData];
        
        // Display all data
        displayTrainings(trainingsData);
        
        // Show toast
        showToast('Filters have been reset.', 'info');
      }
      
      // Search functions
      function searchTrainings() {
        const searchTerm = document.getElementById('trainingsSearchInput').value.toLowerCase().trim();
        
        if (searchTerm === '') {
          // If search is empty, show all data
          filteredTrainingsData = [...trainingsData];
          document.getElementById('trainingsSearchResults').style.display = 'none';
          displayTrainings(filteredTrainingsData);
          return;
        }
        
        // Search across all fields
        filteredTrainingsData = trainingsData.filter(training => {
          try {
            return Object.values(training).some(value => {
              if (value === null || value === undefined) return false;
              
              // Handle arrays or comma-separated strings
              if (typeof value === 'string' && value.includes(',')) {
                return value.split(',').some(part => part.trim().toLowerCase().includes(searchTerm));
              }
              
              // Convert to string and search
              return String(value).toLowerCase().includes(searchTerm);
            });
          } catch (error) {
            console.error("Error searching training:", error, training);
            // Include the item if there's an error to avoid hiding data
            return true;
          }
        });
        
        // Display results count
        const resultsElement = document.getElementById('trainingsSearchResults');
        resultsElement.textContent = `Found ${filteredTrainingsData.length} of ${trainingsData.length} trainings`;
        resultsElement.style.display = 'block';
        
        // Display filtered data
        displayTrainings(filteredTrainingsData);
      }
      
      function clearTrainingsSearch() {
        document.getElementById('trainingsSearchInput').value = '';
        filteredTrainingsData = [...trainingsData];
        document.getElementById('trainingsSearchResults').style.display = 'none';
        displayTrainings(filteredTrainingsData);
      }
      
      function searchTrainees() {
        const searchTerm = document.getElementById('traineesSearchInput').value.toLowerCase().trim();
        
        if (searchTerm === '') {
          // If search is empty, show all data
          filteredTraineesData = [...traineesData];
          document.getElementById('traineesSearchResults').style.display = 'none';
          displayTraineeCards(filteredTraineesData);
          return;
        }
        
        // Search across all fields
        filteredTraineesData = traineesData.filter(trainee => {
          try {
            return Object.values(trainee).some(value => {
              if (value === null || value === undefined) return false;
              
              // Convert to string and search
              return String(value).toLowerCase().includes(searchTerm);
            });
          } catch (error) {
            console.error("Error searching trainee:", error, trainee);
            // Include the item if there's an error to avoid hiding data
            return true;
          }
        });
        
        // Display results count
        const resultsElement = document.getElementById('traineesSearchResults');
        resultsElement.textContent = `Found ${filteredTraineesData.length} of ${traineesData.length} trainees`;
        resultsElement.style.display = 'block';
        
        // Display filtered data
        displayTraineeCards(filteredTraineesData);
      }
      
      function clearTraineesSearch() {
        document.getElementById('traineesSearchInput').value = '';
        filteredTraineesData = [...traineesData];
        document.getElementById('traineesSearchResults').style.display = 'none';
        displayTraineeCards(filteredTraineesData);
      }
      
function displayTrainings(trainings) {
  try {
    const tableBody = document.getElementById('trainingsData');

    if (trainings && trainings.length > 0) {
      let tableContent = '';

      trainings.forEach((training, index) => {
        // Format dates if they exist
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleString();
          } catch (e) {
            return dateStr;
          }
        };

        // Determine status class and icon
        let statusClass = '';
        let statusIcon = '';
        if (training.trainingStatus) {
          const status = training.trainingStatus.toString().toLowerCase();
          if (status.includes('complete')) {
            statusClass = 'status-completed';
            statusIcon = '<i class="fas fa-check-circle"></i>';
          } else if (status.includes('progress')) {
            statusClass = 'status-in-progress';
            statusIcon = '<i class="fas fa-clock"></i>';
          } else if (status.includes('cancel')) {
            statusClass = 'status-canceled';
            statusIcon = '<i class="fas fa-times-circle"></i>';
          } else if (status.includes('reschedule')) {
            statusClass = 'status-rescheduled';
            statusIcon = '<i class="fas fa-calendar-alt"></i>';
          }
        }

        // Create chips for healthcare centers
        let healthcareCentreChips = '';
        if (training.healthcareCentre) {
          try {
            const centres = typeof training.healthcareCentre === 'string' 
              ? training.healthcareCentre.split(',').map(s => s.trim()).filter(s => s)
              : [String(training.healthcareCentre)];
            
            healthcareCentreChips = '<div class="chip-container">';
            centres.forEach(centre => {
              healthcareCentreChips += `<div class="chip"><i class="fas fa-hospital"></i> ${centre}</div>`;
            });
            healthcareCentreChips += '</div>';
          } catch (error) {
            console.error("Error creating healthcare chips:", error);
            healthcareCentreChips = String(training.healthcareCentre);
          }
        }

        // Create chips for device serial numbers
        let deviceSerialChips = '';
        if (training.deviceSerialNumber) {
          try {
            // Handle different possible formats of deviceSerialNumber
            let serials = [];
            
            if (typeof training.deviceSerialNumber === 'string') {
              serials = training.deviceSerialNumber.split(',').map(s => s.trim()).filter(s => s);
            } else if (Array.isArray(training.deviceSerialNumber)) {
              serials = training.deviceSerialNumber.map(s => String(s).trim()).filter(s => s);
            } else {
              serials = [String(training.deviceSerialNumber).trim()];
            }
            
            deviceSerialChips = '<div class="chip-container">';
            serials.forEach(serial => {
              deviceSerialChips += `<div class="chip"><i class="fas fa-barcode"></i> ${serial}</div>`;
            });
            deviceSerialChips += '</div>';
          } catch (error) {
            console.error("Error creating device serial chips:", error);
            deviceSerialChips = String(training.deviceSerialNumber);
          }
        }

        // WhatsApp Group Link
        let whatsappLink = '';
        if (training.whatsappLink) {
          whatsappLink = `<a href="${training.whatsappLink}" target="_blank"><i class="fab fa-whatsapp"></i> Join Group</a>`;
        }

        // Find the original index in the full dataset
        const originalIndex = trainingsData.findIndex(t => t.rowIndex === training.rowIndex);

        tableContent += `
          <tr data-row-index="${training.rowIndex}" data-training-index="${originalIndex}">
            <td>${formatDate(training.timestamp) || ''}</td>
            <td>${training.trainingName || ''}</td>
            <td>${training.trainer || ''}</td>
            <td>${healthcareCentreChips || ''}</td>
            <td class="date-time"><i class="far fa-calendar-alt"></i> ${formatDate(training.startDateTime) || ''}</td>
            <td class="date-time"><i class="far fa-calendar-alt"></i> ${formatDate(training.endDateTime) || ''}</td>
            <td>${deviceSerialChips || ''}</td>
            <td>${training.trainingType || ''}</td>
            <td>${training.gradebookLink ? `<a href="${training.gradebookLink}" target="_blank"><i class="fas fa-book"></i> View Gradebook</a>` : ''}</td>
            <td class="${statusClass}">${statusIcon} ${training.trainingStatus || ''}</td>
            <td>${whatsappLink}</td>
            <td>
              <button class="button" onclick="editTraining(${originalIndex})"><i class="fas fa-edit"></i> Edit</button>
            </td>
          </tr>
        `;
      });

      tableBody.innerHTML = tableContent;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('trainingsTableContainer').style.display = 'block';
    } else {
      tableBody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px;"><i class="fas fa-info-circle"></i> No training available</td></tr>';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('trainingsTableContainer').style.display = 'block';
    }
  } catch (error) {
    console.error("Error in displayTrainings:", error);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('trainingsTableContainer').style.display = 'block';
    showToast("An error occurred while displaying trainings: " + error.message, 'error');
  }
}

      
      function displayTraineeCards(trainees) {
        try {
          const cardsContainer = document.getElementById('traineesCards');
          
          if (trainees && trainees.length > 0) {
            // Group trainees by gradebook link and training name
            const groupedTrainees = {};
            
            trainees.forEach(trainee => {
              const key = trainee.gradebookLink || 'no-gradebook';
              if (!groupedTrainees[key]) {
                groupedTrainees[key] = {
                  trainingName: trainee.trainingName,
                  gradebookLink: trainee.gradebookLink,
                  trainees: []
                };
              }
              groupedTrainees[key].trainees.push(trainee);
            });
            
            // Create cards for each group
            let cardsContent = '';
            
            Object.keys(groupedTrainees).forEach((key, idx) => {
              const group = groupedTrainees[key];
              const traineeCount = group.trainees.length;
              
              // Add delay for staggered animation
              const delay = idx * 0.1;
              
              cardsContent += `
                <div class="card" style="animation-delay: ${delay}s">
                  <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chalkboard-teacher"></i> ${group.trainingName || 'Unnamed Training'}</h3>
                  </div>
                  <div class="card-body">
                    ${group.gradebookLink ? 
                      `<p><a href="${group.gradebookLink}" target="_blank"><i class="fas fa-book"></i> View Gradebook</a></p>` : 
                      '<p><i class="fas fa-exclamation-circle"></i> No gradebook available</p>'}
                  </div>
                  <div class="card-footer">
                    <span class="trainee-count"><i class="fas fa-users"></i> ${traineeCount} Trainee${traineeCount !== 1 ? 's' : ''}</span>
                    <button class="button view-button" onclick="viewTrainees('${key}')"><i class="fas fa-eye"></i> View Trainees</button>
                  </div>
                </div>
              `;
            });
            
            cardsContainer.innerHTML = cardsContent;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('traineesCardContainer').style.display = 'block';
          } else {
            cardsContainer.innerHTML = '<div style="text-align: center; color: white; padding: 20px; background-color: rgba(255,255,255,0.1); border-radius: 8px;"><i class="fas fa-info-circle"></i> No training available</div>';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('traineesCardContainer').style.display = 'block';
          }
        } catch (error) {
          console.error("Error in displayTraineeCards:", error);
          document.getElementById('loading').style.display = 'none';
          document.getElementById('traineesCardContainer').style.display = 'block';
          showToast("An error occurred while displaying trainee cards: " + error.message, 'error');
        }
      }
      
      function viewTrainees(gradebookKey) {
        try {
          // Find trainees with this gradebook link
          const trainees = filteredTraineesData.filter(trainee => 
            (trainee.gradebookLink || 'no-gradebook') === gradebookKey
          );
          
          if (!trainees || trainees.length === 0) {
            showError('No trainees found for this training.');
            return;
          }
          
          // Get training name from the first trainee
          const trainingName = trainees[0].trainingName || 'Unnamed Training';
          
          // Create modal
          const modal = document.createElement('div');
          modal.className = 'modal';
          
          const modalContent = document.createElement('div');
          modalContent.className = 'modal-content';
          modalContent.style.position = 'relative';
          
          // Create close button
          const closeButton = document.createElement('button');
          closeButton.className = 'close-button';
          closeButton.innerHTML = '<i class="fas fa-times"></i>';
          closeButton.onclick = closeModal;
          
          // Create modal header
          const modalHeader = document.createElement('div');
          modalHeader.innerHTML = `
            <h2 class="modal-title"><i class="fas fa-users"></i> ${trainingName}</h2>
            <p class="modal-subtitle">${trainees.length} Trainee${trainees.length !== 1 ? 's' : ''}</p>
          `;
          
          // Create trainee list
          const traineeList = document.createElement('div');
          traineeList.className = 'trainee-list';
          
          let traineeListContent = '';
          
          trainees.forEach((trainee, idx) => {
            // Add delay for staggered animation
            const delay = idx * 0.05;
            
            // Determine grade class and icon
            let gradeClass = '';
            let gradeIcon = '';
            if (trainee.grade) {
              const grade = trainee.grade.toString().toLowerCase();
              if (grade === 'ungraded') {
                gradeClass = 'grade-ungraded';
                gradeIcon = '<i class="fas fa-minus-circle"></i>';
              }
              else if (grade.includes('pass')) {
                gradeClass = 'grade-pass';
                gradeIcon = '<i class="fas fa-check-circle"></i>';
              }
              else if (grade.includes('fail')) {
                gradeClass = 'grade-fail';
                gradeIcon = '<i class="fas fa-times-circle"></i>';
              }
            } else {
              gradeClass = 'grade-ungraded';
              gradeIcon = '<i class="fas fa-minus-circle"></i>';
            }
            
            // Add remarks section (read-only)
            const hasRemarks = trainee.remarks && trainee.remarks.trim() !== '';
            const remarksSection = `
              <div class="remarks-container">
                <div class="remarks-title">
                  <i class="fas fa-comment-alt"></i> Remarks
                </div>
                <div class="remarks-content">
                  ${hasRemarks ? trainee.remarks : '<span class="remarks-empty">No remarks available</span>'}
                </div>
              </div>
            `;
            
            traineeListContent += `
              <div class="trainee-item" style="animation-delay: ${delay}s">
                <div class="trainee-name">
                  <span><i class="fas fa-user"></i> ${trainee.traineeName || 'Unnamed Trainee'}</span>
                  <span class="badge badge-primary ${gradeClass}">${gradeIcon} ${trainee.grade || 'Ungraded'}</span>
                </div>
                <div class="trainee-details">
                  <div><i class="fas fa-id-card"></i> ID: ${trainee.traineeId || 'N/A'}</div>
                  <div><i class="fas fa-passport"></i> IC/Passport: ${trainee.icPassport || 'N/A'}</div>
                  <div><i class="fas fa-hospital"></i> Affiliated Healthcare: ${trainee.affiliatedHealthcare || 'N/A'}</div>
                </div>
                ${remarksSection}
              </div>
            `;
          });
          
          traineeList.innerHTML = traineeListContent;
          
          // Assemble modal
          modalContent.appendChild(closeButton);
          modalContent.appendChild(modalHeader);
          modalContent.appendChild(traineeList);
          modal.appendChild(modalContent);
          
          // Add modal to body
          document.body.appendChild(modal);
        } catch (error) {
          console.error("Error in viewTrainees:", error);
          showToast("An error occurred while viewing trainees: " + error.message, 'error');
        }
      }
      
      function editTraining(index) {
        try {
          const training = trainingsData[index];
          if (!training) {
            showToast("Training data not found", 'error');
            return;
          }
          
          const rowIndex = training.rowIndex;
          
          // Check if user can edit status
          const canEditStatus = dropdownOptions && 
                               dropdownOptions.authorizedEmails && 
                               dropdownOptions.authorizedEmails.includes(currentUserEmail);
          
          // Create modal
          const modal = document.createElement('div');
          modal.className = 'modal';
          
          const modalContent = document.createElement('div');
          modalContent.className = 'modal-content';
          
          // Create close button
          const closeButton = document.createElement('button');
          closeButton.className = 'close-button';
          closeButton.innerHTML = '<i class="fas fa-times"></i>';
          closeButton.onclick = closeModal;
          
          // Create modal header
          const modalHeader = document.createElement('h2');
          modalHeader.className = 'modal-title';
          modalHeader.innerHTML = '<i class="fas fa-edit"></i> Edit Training';
          
          // Create form content
          const formContent = document.createElement('div');
          
          // Prepare device serial numbers for display
          let deviceSerials = [];
          if (training.deviceSerialNumber) {
            try {
              if (typeof training.deviceSerialNumber === 'string') {
                deviceSerials = training.deviceSerialNumber.split(',').map(s => s.trim()).filter(s => s);
              } else if (Array.isArray(training.deviceSerialNumber)) {
                deviceSerials = training.deviceSerialNumber.map(s => String(s).trim()).filter(s => s);
              } else {
                deviceSerials = [String(training.deviceSerialNumber).trim()];
              }
            } catch (error) {
              console.error("Error processing device serial numbers:", error);
              deviceSerials = [String(training.deviceSerialNumber)];
            }
          }
          
          formContent.innerHTML = `
            <div class="form-group">
              <label for="modal-trainingName"><i class="fas fa-tag"></i> Training ID:</label>
              <input type="text" id="modal-trainingName" value="${training.trainingName || ''}" readonly>
            </div>
            
            <div class="form-group">
              <label for="modal-trainer"><i class="fas fa-user-tie"></i> Trainer:</label>
              <select id="modal-trainer">
                ${dropdownOptions && dropdownOptions.trainers ? dropdownOptions.trainers.map(trainer => 
                  `<option value="${trainer}" ${trainer === training.trainer ? 'selected' : ''}>${trainer}</option>`
                ).join('') : ''}
              </select>
            </div>
            
            <div class="form-group">
              <label for="modal-healthcareCentre"><i class="fas fa-hospital"></i> Healthcare Centre:</label>
              <select id="modal-healthcareCentre" multiple="multiple" class="multiselect">
                ${dropdownOptions && dropdownOptions.healthcareCentres ? dropdownOptions.healthcareCentres.map(centre => {
                  let isSelected = false;
                  try {
                    if (typeof training.healthcareCentre === 'string') {
                      isSelected = training.healthcareCentre.split(',').map(s => s.trim()).includes(centre);
                    } else if (training.healthcareCentre) {
                      isSelected = String(training.healthcareCentre).trim() === centre;
                    }
                  } catch (error) {
                    console.error("Error checking healthcare selection:", error);
                  }
                  return `<option value="${centre}" ${isSelected ? 'selected' : ''}>${centre}</option>`;
                }).join('') : ''}
              </select>
            </div>
            
            <div class="form-group">
              <label for="modal-startDateTime"><i class="far fa-calendar-alt"></i> Start Date & Time:</label>
              <input type="text" id="modal-startDateTime" value="${training.startDateTime || ''}" class="datepicker">
            </div>
            
            <div class="form-group">
              <label for="modal-endDateTime"><i class="far fa-calendar-alt"></i> End Date & Time:</label>
              <input type="text" id="modal-endDateTime" value="${training.endDateTime || ''}" class="datepicker">
            </div>
            
            <div class="form-group">
              <label for="device-serial-container"><i class="fas fa-barcode"></i> Device Serial Number:</label>
              <div id="device-serial-container" class="tag-input-container">
                ${deviceSerials.map(serial => 
                  `<div class="tag" data-value="${serial}">
                    ${serial}
                    <span class="tag-remove" onclick="removeDeviceTag(this)"><i class="fas fa-times"></i></span>
                  </div>`
                ).join('')}
                <input type="text" id="device-serial-input" class="tag-input" placeholder="Type and press Enter to add...">
              </div>
              <div id="device-suggestions" class="tag-suggestions" style="display: none;"></div>
              <div style="margin-top: 5px; font-size: 12px; color: #666;">
                <i class="fas fa-info-circle"></i> You can add custom serial numbers or select from suggestions
              </div>
            </div>
            
            <div class="form-group">
              <label for="modal-whatsappLink"><i class="fab fa-whatsapp"></i> WhatsApp Group Link:</label>
              <input type="text" id="modal-whatsappLink" value="${training.whatsappLink || ''}">
            </div>
            
            ${canEditStatus ? `
            <div class="form-group">
              <label for="modal-trainingStatus"><i class="fas fa-info-circle"></i> Status:</label>
              <select id="modal-trainingStatus">
                <option value="In Progress" ${training.trainingStatus === 'In Progress' ? 'selected' : ''}>In Progress</option>
                <option value="Completed" ${training.trainingStatus === 'Completed' ? 'selected' : ''}>Completed</option>
                <option value="Canceled" ${training.trainingStatus === 'Canceled' ? 'selected' : ''}>Canceled</option>
                <option value="Rescheduled" ${training.trainingStatus === 'Rescheduled' ? 'selected' : ''}>Rescheduled</option>
              </select>
            </div>
            ` : ''}
            
            <div class="button-group">
              <button class="button cancel-button" onclick="closeModal()"><i class="fas fa-times-circle"></i> Cancel</button>
              <button class="button save-button" onclick="saveTraining(${rowIndex}, ${index})"><i class="fas fa-save"></i> Save Changes</button>
            </div>
          `;
          
          // Assemble modal
          modalContent.appendChild(closeButton);
          modalContent.appendChild(modalHeader);
          modalContent.appendChild(formContent);
          modal.appendChild(modalContent);
          
          // Add modal to body
          document.body.appendChild(modal);
          
          // Initialize special controls
          setTimeout(() => {
            // Setup device serial number tag input
            setupDeviceSerialTagInput(dropdownOptions && dropdownOptions.deviceSerials ? dropdownOptions.deviceSerials : []);
            
            flatpickr("#modal-startDateTime", {
              enableTime: true,
              dateFormat: "Z",
              altInput: true,
              altFormat: "F j, Y at h:i K",
              onChange: function(selectedDates, dateStr) {
                // Update end date min date when start date changes
                const endDatepicker = document.getElementById('modal-endDateTime')._flatpickr;
                endDatepicker.set('minDate', dateStr);
              }
            });
            
            flatpickr("#modal-endDateTime", {
              enableTime: true,
              dateFormat: "Z",
              altInput: true,
              altFormat: "F j, Y at h:i K",
              minDate: document.getElementById('modal-startDateTime').value
            });
            
            $("#modal-healthcareCentre").select2({
              placeholder: "Select Healthcare Centres",
              allowClear: true,
              width: '100%',
              dropdownParent: modal,
              templateSelection: formatSelection,
              templateResult: formatResult
            });
            
            $("#modal-trainer").select2({
              placeholder: "Select Trainer",
              width: '100%',
              dropdownParent: modal
            });
            
            if (canEditStatus) {
              $("#modal-trainingStatus").select2({
                width: '100%',
                dropdownParent: modal,
                minimumResultsForSearch: Infinity
              });
            }
            
            // Format select2 options with icons
            function formatSelection(state) {
              if (!state.id) return state.text;
              
              let icon = '';
              if (state.element && state.element.parentElement.id === 'modal-healthcareCentre') {
                icon = '<i class="fas fa-hospital"></i> ';
              }
              
              return $(`<span>${icon}${state.text}</span>`);
            }
            
            function formatResult(state) {
              if (!state.id) return state.text;
              
              let icon = '';
              if (state.element && state.element.parentElement.id === 'modal-healthcareCentre') {
                icon = '<i class="fas fa-hospital"></i> ';
              }
              
              return $(`<div class="select-option">${icon}${state.text}</div>`);
            }
          }, 100);
        } catch (error) {
          console.error("Error in editTraining:", error);
          showToast("An error occurred while opening the edit form: " + error.message, 'error');
        }
      }
      
      // Setup device serial number tag input
      function setupDeviceSerialTagInput(suggestions) {
        const input = document.getElementById('device-serial-input');
        const container = document.getElementById('device-serial-container');
        const suggestionsContainer = document.getElementById('device-suggestions');
        
        if (!input || !container || !suggestionsContainer) return;
        
        // Add tag when Enter is pressed
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const value = input.value.trim();
            if (value) {
              addDeviceTag(value);
              input.value = '';
              suggestionsContainer.style.display = 'none';
            }
          }
        });
        
        // Show suggestions as user types
        input.addEventListener('input', function() {
          const value = input.value.trim().toLowerCase();
          if (value.length < 1) {
            suggestionsContainer.style.display = 'none';
            return;
          }
          
          // Filter suggestions
          const filtered = suggestions.filter(s => 
            s.toLowerCase().includes(value) && 
            !Array.from(container.querySelectorAll('.tag')).some(tag => tag.dataset.value === s)
          );
          
          if (filtered.length > 0) {
            suggestionsContainer.innerHTML = filtered.map(s => 
              `<div class="tag-suggestion-item" onclick="addDeviceTag('${s}')">${s}</div>`
            ).join('');
            suggestionsContainer.style.display = 'block';
          } else {
            suggestionsContainer.style.display = 'none';
          }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
          if (!container.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            suggestionsContainer.style.display = 'none';
          }
        });
        
        // Focus input when clicking on container
        container.addEventListener('click', function(e) {
          if (e.target === container) {
            input.focus();
          }
        });
      }
      
      // Add device tag function (global for onclick)
      window.addDeviceTag = function(value) {
        const container = document.getElementById('device-serial-container');
        const input = document.getElementById('device-serial-input');
        const suggestionsContainer = document.getElementById('device-suggestions');
        
        // Check if tag already exists
        if (Array.from(container.querySelectorAll('.tag')).some(tag => tag.dataset.value === value)) {
          return;
        }
        
        // Create new tag
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.dataset.value = value;
        tag.innerHTML = `
          ${value}
          <span class="tag-remove" onclick="removeDeviceTag(this)"><i class="fas fa-times"></i></span>
        `;
        
        // Insert before input
        container.insertBefore(tag, input);
        
        // Clear input and hide suggestions
        input.value = '';
        suggestionsContainer.style.display = 'none';
        
        // Focus input
        input.focus();
      };
      
      // Remove device tag function (global for onclick)
      window.removeDeviceTag = function(element) {
        const tag = element.closest('.tag');
        if (tag) {
          tag.remove();
        }
      };
      
      // Add close modal function to window
      window.closeModal = function() {
        const modal = document.querySelector('.modal');
        if (modal) {
          document.body.removeChild(modal);
        }
      };
      
      // Add save training function to window
      window.saveTraining = function(rowIndex, index) {
        try {
          // Show spinner
          showSpinner();
          
          // Check if user can edit status
          const canEditStatus = dropdownOptions && 
                               dropdownOptions.authorizedEmails && 
                               dropdownOptions.authorizedEmails.includes(currentUserEmail);
          
          // Get the original training name for comparison
          const originalTrainingName = trainingsData[index].trainingName;
          
          // Get all device serial tags
          const deviceTags = Array.from(document.querySelectorAll('#device-serial-container .tag'))
            .map(tag => tag.dataset.value);
          
          // Prepare the update data
          const updateData = {
            trainingName: document.getElementById('modal-trainingName').value,
            trainer: document.getElementById('modal-trainer').value,
            healthcareCentre: Array.from(document.getElementById('modal-healthcareCentre').selectedOptions)
                            .map(option => option.value).join(', '),
            startDateTime: document.getElementById('modal-startDateTime')._flatpickr.selectedDates[0].toISOString(),
            endDateTime: document.getElementById('modal-endDateTime')._flatpickr.selectedDates[0].toISOString(),
            deviceSerialNumber: deviceTags.join(', '),
            whatsappLink: document.getElementById('modal-whatsappLink').value
          };
          
          // Add status if user can edit it
          if (canEditStatus) {
            updateData.trainingStatus = document.getElementById('modal-trainingStatus').value;
          }
          
          // Validate dates
          const startDate = new Date(updateData.startDateTime);
          const endDate = new Date(updateData.endDateTime);
          
          if (endDate < startDate) {
            hideSpinner();
            showToast('End date cannot be before start date', 'error');
            return;
          }
          
          // Send update to server
          google.script.run
            .withSuccessHandler(function(response) {
              hideSpinner();
              
              if (response && response.success) {
                // Update the local data
                Object.keys(updateData).forEach(key => {
                  trainingsData[index][key] = updateData[key];
                });
                
                // If training name was changed, update it in trainees data too
                if (updateData.trainingName !== originalTrainingName && traineesData.length > 0) {
                  traineesData.forEach(trainee => {
                    if (trainee.trainingName === originalTrainingName) {
                      trainee.trainingName = updateData.trainingName;
                    }
                  });
                  
                  // If we're on the trainees page, refresh the display
                  if (currentPage === 'trainees') {
                    displayTraineeCards(traineesData);
                  }
                }
                
                // Close the modal
                closeModal();
                
                // Update filtered data if needed
                if (filteredTrainingsData !== trainingsData) {
                  // Find the training in filtered data and update it
                  const filteredIndex = filteredTrainingsData.findIndex(t => t.rowIndex === rowIndex);
                  if (filteredIndex !== -1) {
                    Object.keys(updateData).forEach(key => {
                      filteredTrainingsData[filteredIndex][key] = updateData[key];
                    });
                  }
                }
                
                // Refresh the display with the current filtered data
                displayTrainings(filteredTrainingsData);
                
                // Refresh filter options
                populateFilterOptions(trainingsData);
                
                // Show success toast
                showToast(response.message || 'Training updated successfully!', 'success');
              } else {
                showToast(response.error || 'Update failed', 'error');
              }
            })
            .withFailureHandler(function(error) {
              hideSpinner();
              showToast('Error: ' + error, 'error');
            })
            .updateTraining(rowIndex, updateData);
        } catch (error) {
          hideSpinner();
          console.error("Error in saveTraining:", error);
          showToast("An error occurred while saving: " + error.message, 'error');
        }
      };
      
      function showSpinner() {
        // Create spinner overlay if it doesn't exist
        if (!document.querySelector('.spinner-overlay')) {
          const spinnerOverlay = document.createElement('div');
          spinnerOverlay.className = 'spinner-overlay';
          
          const spinner = document.createElement('div');
          spinner.className = 'spinner';
          
          spinnerOverlay.appendChild(spinner);
          document.body.appendChild(spinnerOverlay);
        }
      }
      
      function hideSpinner() {
        const spinnerOverlay = document.querySelector('.spinner-overlay');
        if (spinnerOverlay) {
          document.body.removeChild(spinnerOverlay);
        }
      }

      function setupSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarMobileToggle = document.getElementById('sidebar-mobile-toggle');
        const toggleIcon = sidebarToggle.querySelector('i');
        
        // Toggle sidebar collapse state
        sidebarToggle.addEventListener('click', function() {
          if (sidebar.classList.contains('collapsed')) {
            // Expand sidebar
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('sidebar-collapsed');
            toggleIcon.classList.remove('fa-chevron-right');
            toggleIcon.classList.add('fa-chevron-left');
          } else {
            // Collapse sidebar
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            toggleIcon.classList.remove('fa-chevron-left');
            toggleIcon.classList.add('fa-chevron-right');
          }
        });
        
        // Mobile sidebar toggle
        sidebarMobileToggle.addEventListener('click', function() {
          sidebar.classList.toggle('active');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
          const isMobile = window.innerWidth <= 992;
          if (isMobile && 
              !sidebar.contains(event.target) && 
              !sidebarMobileToggle.contains(event.target) &&
              sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
          }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
          if (window.innerWidth > 992) {
            sidebar.classList.remove('active');
          }
        });
      }
      
      function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        let icon = '';
        switch(type) {
          case 'success':
            icon = '<i class="fas fa-check-circle"></i>';
            break;
          case 'error':
            icon = '<i class="fas fa-exclamation-circle"></i>';
            break;
          default:
            icon = '<i class="fas fa-info-circle"></i>';
        }
        
        toast.innerHTML = `${icon} ${message}`;
        
        // Add click to dismiss
        toast.addEventListener('click', function() {
          toastContainer.removeChild(toast);
        });
        
        toastContainer.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
          if (toast.parentNode === toastContainer) {
            toastContainer.removeChild(toast);
          }
        }, 3000);
      }
      
      function showError(error) {
        document.getElementById('loading').style.display = 'none';
        showToast('Error: ' + error, 'error');
      }
      
      function showSuccess(message) {
        showToast(message, 'success');
      }
      
      // Handle window resize for tab indicator
      window.addEventListener('resize', updateTabIndicator);
      
      // Make search functions available globally
      window.searchTrainings = searchTrainings;
      window.clearTrainingsSearch = clearTrainingsSearch;
      window.searchTrainees = searchTrainees;
      window.clearTraineesSearch = clearTraineesSearch;
    </script>
  </body>
</html>